name: SomeBuild
on:
  push:
    branches: [ "before_integration" ]
  pull_request:
   branches: [ "before_integration" ]
permissions:
  actions: read # for detecting the Github Actions environment.
  id-token: write # for creating OIDC tokens for signing.
  packages: write # for uploading attestations.
  contents: read

  
jobs:
  build-publish-docker:
    runs-on: ubuntu-latest
    env:
      DOCKER_REPO: docker
      IMAGE_NAME: swampapp
      JF_URL: https://${{ vars.JF_URL }}/
      DOCKER_BUILD_SUMMARY: false
      DOCKER_BUILD_RECORD_UPLOAD: false
      
    steps:

    - name: Checkout the repository
      uses: actions/checkout@v4

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v3
      id: setup-cli
      env:
       JF_URL: https://${{ vars.JF_URL }}/
       JF_PROJECT: ${{ vars.JF_PROJECT }}
       JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
     
    - name: Set CLI Config
      run: jf npm-config --global=true --repo-resolve=devrel-npm --repo-deploy=devrel-npm
      
    - name: build webapp
      run: |
         jf npm ci
         npm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Authenticate Docker
      uses: docker/login-action@v3
      with:
         # JFrog platform url (for example: https://acme.jfrog.io)
         registry: ${{ vars.JF_URL }} 
         username: 'yonatan'
         password: ${{ secrets.JF_ACCESS_TOKEN }}
